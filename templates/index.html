<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Microstrip Line Calculator</title>
    <style>
      :root {
        --accent: #2f6f9f;
        --muted: #6b6b6b;
        --card: #fff;
        --bg: #f6f7f8;
      }
      body {
        font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: #222;
        margin: 0;
        padding: 28px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        max-width: 800px;
        width: 100%;
        background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
        box-shadow: 0 6px 18px rgba(20, 20, 40, 0.06);
        border-radius: 10px;
        padding: 24px;
        text-align: center;
      }
      h1 {
        font-size: 26px;
        color: var(--accent);
        margin: 6px 0 18px;
      }
      .preview {
        background: #fff;
        border: 1px solid #e6e6e6;
        padding: 12px;
        border-radius: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 20px;
        max-width: 400px;
      }
      .preview img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
      }
      .fieldset {
        background: #fff;
        border-radius: 6px;
        padding: 14px;
        border: 1px solid #eee;
        margin-top: 14px;
        text-align: left;
      }
      .section-title {
        font-weight: 700;
        margin: 8px 0;
        color: #333;
        text-align: center;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="number"],
      select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-size: 14px;
      }
      .controls {
        display: flex;
        justify-content: center;
        margin-top: 14px;
        gap: 10px;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
      }
      button:hover {
        background: #275a83;
      }
      .toggle-mode {
        background: #fff;
        color: var(--accent);
        border: 1px solid var(--accent);
      }
      .toggle-mode.active {
        background: var(--accent);
        color: #fff;
      }
      .output-box {
        background: #f1f7ff;
        border: 1px solid #c9e0f5;
        border-radius: 6px;
        padding: 12px;
        margin-top: 14px;
        font-size: 14px;
        color: #222;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container" role="main">
      <h1>Microstrip Line Calculator</h1>

      <div class="preview" aria-hidden="true">
        <img src="{{ url_for('static', filename='images/image1.jpg') }}" alt="Microstrip diagram" />
      </div>

      <form id="microstripForm" method="POST">
        <!-- Substrate Parameters -->
        <div class="fieldset">
          <div class="section-title">Substrate Parameters</div>
          <div class="form-grid">
            <div>
              <label for="er">Dielectric Constant (ε<sub>r</sub>)</label>
              <input id="er" name="er" type="number" step="0.01" value="4.4" min="1" />
            </div>
            <div>
              <label for="h">Dielectric Height (h)</label>
              <div style="display: flex; gap: 8px">
                <input id="h" name="h" type="number" step="0.01" value="1.6" />
                <select id="hUnit" name="hUnit">
                  <option>mm</option>
                  <option>cm</option>
                </select>
              </div>
            </div>
            <div>
              <label for="freq">Frequency</label>
              <div style="display: flex; gap: 8px">
                <input id="freq" name="freq" type="number" step="0.01" value="2.4" />
                <span style="align-self: center; color: var(--muted)">GHz</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Formula -->
        <div class="fieldset">
          <div class="section-title">Formula</div>
          <select id="formula" name="formula">
            <option>Hammerstad and Jensen</option>
            <option>Wheeler 1965</option>
            <option>Wheeler 1977</option>
            <option>Hammerstad 1975</option>
            <option>Schneider</option>
            <option>IPC2141</option>
          </select>
        </div>

        <!-- Toggle + Calculation -->
        <div class="fieldset">
          <div class="section-title">Mode Selection</div>
          <div class="controls">
            <button type="button" id="synthesizeBtn" class="toggle-mode active">Synthesize</button>
            <button type="button" id="analyzeBtn" class="toggle-mode">Analyze</button>
          </div>

          <div id="inputFields" class="form-grid" style="margin-top: 12px;"></div>

          <div class="controls">
            <button id="calculate" type="button">Calculate</button>
          </div>

          <div id="output" class="output-box" style="display:none;"></div>
        </div>
      </form>
    </div>

    <script>
      const synthesizeBtn = document.getElementById("synthesizeBtn");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const inputFields = document.getElementById("inputFields");
      const output = document.getElementById("output");
      let mode = "synthesize"; // Default mode

      const renderFields = () => {
        if (mode === "synthesize") {
          inputFields.innerHTML = `
            <div>
              <label for="zo">Z<sub>o</sub></label>
              <input id="zo" name="zo" type="number" step="0.01" value="50" />
            </div>
            <div>
              <label for="elecLen">Electrical Length (deg)</label>
              <input id="elecLen" name="elecLen" type="number" step="0.01" value="45" />
            </div>
          `;
        } else {
          inputFields.innerHTML = `
            <div>
              <label for="w">Width (W)</label>
              <div style="display: flex; gap: 8px">
                <input id="w" name="w" type="number" step="0.01" value="3" />
                <select id="wUnit" name="wUnit">
                  <option>mm</option>
                  <option>cm</option>
                </select>
              </div>
            </div>
            <div>
              <label for="l">Length (L)</label>
              <div style="display: flex; gap: 8px">
                <input id="l" name="l" type="number" step="0.01" value="2" />
                <select id="lUnit" name="lUnit">
                  <option>mm</option>
                  <option>cm</option>
                </select>
              </div>
            </div>
          `;
        }
      };

      // Initial render
      renderFields();

      synthesizeBtn.addEventListener("click", () => {
        mode = "synthesize";
        synthesizeBtn.classList.add("active");
        analyzeBtn.classList.remove("active");
        renderFields();
        output.style.display = "none";
      });

      analyzeBtn.addEventListener("click", () => {
        mode = "analyze";
        analyzeBtn.classList.add("active");
        synthesizeBtn.classList.remove("active");
        renderFields();
        output.style.display = "none";
      });

      document.getElementById("calculate").addEventListener("click", async function () {
        const er = parseFloat(document.getElementById("er").value);
        const freq = parseFloat(document.getElementById("freq").value);
        let h = parseFloat(document.getElementById("h").value);
        if (document.getElementById("hUnit").value === "cm") h *= 10;
        const formula = document.getElementById("formula").value;

        let payload = { er, h, freq, formula };

        let endpoint = "";

        if (mode === "synthesize") {
          payload.zo = parseFloat(document.getElementById("zo").value);
          payload.elecLen = parseFloat(document.getElementById("elecLen").value);
          endpoint = "/synthesize";
        } else {
          let w = parseFloat(document.getElementById("w").value);
          let l = parseFloat(document.getElementById("l").value);
          if (document.getElementById("wUnit").value === "cm") w *= 10;
          if (document.getElementById("lUnit").value === "cm") l *= 10;
          payload.width_mm = w;
          payload.length_mm = l;
          endpoint = "/analyze";
        }

        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();

          output.style.display = "block";
          if (mode === "synthesize") {
            output.innerHTML = `
              <strong>Results:</strong><br/>
              Width (W): ${data.width_mm?.toFixed(3)} mm<br/>
              Length (L): ${data.length_mm?.toFixed(3)} mm
            `;
          } else {
            output.innerHTML = `
              <strong>Results:</strong><br/>
              Z₀: ${data.zo?.toFixed(3)} Ω<br/>
              Electrical Length: ${data.elecLen?.toFixed(3)}°
            `;
          }
        } catch (err) {
          console.error("Error in request:", err);
          output.style.display = "block";
          output.innerHTML = `<span style="color:red;">Error: Unable to calculate. Check backend or connection.</span>`;
        }
      });
    </script>
  </body>
</html>
